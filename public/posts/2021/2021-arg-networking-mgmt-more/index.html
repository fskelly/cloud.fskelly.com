<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>fletchers-cloud-blog/posts/2021/2021-arg-networking-mgmt-more/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Azure Resource Graph - More queries for Networking and Management Groups" />
<meta property="og:description" content="More queries for Kusto and Enterprise Scale Landing Zone checks." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/2021/2021-arg-networking-mgmt-more/" /><meta property="article:published_time" content="2021-12-09T08:00:00+00:00" />



<meta name="twitter:title" content="Azure Resource Graph - More queries for Networking and Management Groups"/>
<meta name="twitter:description" content="More queries for Kusto and Enterprise Scale Landing Zone checks."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="http://localhost:1313/" class="no-style site-name">fletchers-cloud-blog</a>:~# 
              <a href='http://localhost:1313/posts'>posts</a>/<a href='http://localhost:1313/posts/2021'>2021</a>/<a href='http://localhost:1313/posts/2021/2021-arg-networking-mgmt-more'>2021-arg-networking-mgmt-more</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="http://localhost:1313/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="http://localhost:1313/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>Azure Resource Graph - More queries for Networking and Management Groups</h1>

Dec. 9, 2021


<br/><br/>
<p>Just some more queries I have developed.</p>
<h2 id="networking">Networking</h2>
<p><strong>Don&rsquo;t create unnecessarily large virtual networks (for example, /16) to ensure that IP address space isn&rsquo;t wasted.</strong></p>
<pre tabindex="0"><code class="language-Kusto" data-lang="Kusto">resources
| where type == &#34;microsoft.network/virtualnetworks&#34;
| extend addressSpace = todynamic(properties.addressSpace)
| extend addressPrefix = todynamic(properties.addressSpace.addressPrefixes)
| mvexpand addressSpace
| mvexpand addressPrefix
| extend addressMask = split(addressPrefix,&#39;/&#39;)[1]
| where addressMask &lt;= 16
</code></pre><p>Smallest recommended size for a GatewaySubnet is /27</p>
<p><strong>When you are planning your gateway subnet size, refer to the documentation for the configuration that you are planning to create. For example, the ExpressRoute/VPN Gateway coexist configuration requires a larger gateway subnet than most other configurations. Additionally, you may want to make sure your gateway subnet contains enough IP addresses to accommodate possible future additional configurations. While you can create a gateway subnet as small as /29, we recommend that you create a gateway subnet of /27 or larger (/27, /26 etc.) if you have the available address space to do so. This will accommodate most configurations.</strong> <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsub">Microsoft Docs</a></p>
<pre tabindex="0"><code class="language-kusto" data-lang="kusto">resources
| where type == &#34;microsoft.network/virtualnetworks&#34;
| extend subnets = todynamic(properties.subnets)
| mvexpand subnets
| project VNetname=name,SubnetName=subnets.name, resourceGroup, location, CIDR=subnets.properties.addressPrefix, id
| where SubnetName == &#39;GatewaySubnet&#39;
| extend subnetMask = split(CIDR,&#39;/&#39;)[1]
| where subnetMask &gt;= 27
</code></pre><p><strong>Use IP addresses from the address allocation for private internets (RFC 1918).</strong><a href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/plan-for-ip-addressing">Plan for IP addressing</a></p>
<pre tabindex="0"><code class="language-kusto" data-lang="kusto">resources | where type == &#39;microsoft.network/virtualnetworks&#39; | extend addressSpace = todynamic(properties.addressSpace) | extend addressPrefix = todynamic(properties.addressSpace.addressPrefixes) | mvexpand addressSpace | mvexpand addressPrefix | project name, id, location, resourceGroup, subscriptionId, cidr = addressPrefix | where cidr matches regex @&#39;^(?:10|127|172\\.(?:1[6-9]|2[0-9]|3[01])|192\\.168)\\..*&#39;
</code></pre><pre tabindex="0"><code class="language-kusto" data-lang="kusto">resources | where type == &#39;microsoft.network/virtualnetworks&#39; | extend addressSpace = todynamic(properties.addressSpace) | extend addressPrefix = todynamic(properties.addressSpace.addressPrefixes) | mvexpand addressSpace | mvexpand addressPrefix | project name, id, location, resourceGroup, subscriptionId, cidr = addressPrefix | where not (cidr matches regex @&#39;^(?:10|127|172\\.(?:1[6-9]|2[0-9]|3[01])|192\\.168)\\..*&#39;)
</code></pre><p><strong>Don&rsquo;t create unnecessarily large virtual networks (for example, /16) to ensure that IP address space isn&rsquo;t wasted. <a href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/plan-for-ip-addressing">Plan for IP addressing</a></strong></p>
<pre tabindex="0"><code class="language-kusto" data-lang="kusto">resources | where type == &#39;microsoft.network/virtualnetworks&#39; | extend addressSpace = todynamic(properties.addressSpace) | extend addressPrefix = todynamic(properties.addressSpace.addressPrefixes) | mvexpand addressSpace | mvexpand addressPrefix | extend addressMask = split(addressPrefix,&#39;/&#39;)[1] | where addressMask &gt; 16 | project name, id, subscriptionId, resourceGroup, addressPrefix
</code></pre><pre tabindex="0"><code class="language-kusto" data-lang="kusto">resources | where type == &#39;microsoft.network/virtualnetworks&#39; | extend addressSpace = todynamic(properties.addressSpace) | extend addressPrefix = todynamic(properties.addressSpace.addressPrefixes) | mvexpand addressSpace | mvexpand addressPrefix | extend addressMask = split(addressPrefix,&#39;/&#39;)[1] | where addressMask &lt;= 16 | project name, id, subscriptionId, resourceGroup, addressPrefix
</code></pre><h2 id="management-groups">Management Groups</h2>
<p><strong>Keep the management group hierarchy reasonably flat, with no more than three to four levels ideally. This restriction reduces management overhead and complexity.</strong>
<a href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/enterprise-scale/management-group-and-subscription-organization">Define a management group hierarchy</a></p>
<pre tabindex="0"><code class="language-kusto" data-lang="kusto">resourcecontainers
| where type == &#34;microsoft.resources/subscriptions&#34;
| extend ManagementGroup = tostring(tags),mgmtChain = properties.managementGroupAncestorsChain
| where array_length(mgmtChain) ==1
|mvexpand mgmt=mgmtChain
|project id, subName = name, subscriptionId, managedBy, managementGroupName = mgmt.displayName
</code></pre><pre tabindex="0"><code class="language-kusto" data-lang="kusto">resourcecontainers
| where type == &#34;microsoft.resources/subscriptions&#34;
| extend ManagementGroup = tostring(tags),mgmtChain = properties.managementGroupAncestorsChain
| where array_length(mgmtChain) &gt;=4
|mvexpand mgmt=mgmtChain
</code></pre><p>Follow me for more.<br>
<a href="https://twitter.com/fskelly">Twitter</a><br>
<a href="https://www.linkedin.com/in/fletcherkelly/">LinkedIn</a></p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
