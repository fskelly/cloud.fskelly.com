<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>console-demo/posts/2023/starting-wth-rest-calls-with-powershell/about/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Starting Wth API Rest Calls With Powershell" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/2023/starting-wth-rest-calls-with-powershell/about/" /><meta property="article:published_time" content="2023-08-17T09:09:54+01:00" />



<meta name="twitter:title" content="Starting Wth API Rest Calls With Powershell"/>
<meta name="twitter:description" content="What are we doing?
I am working more and more with the Azure REST APIs now. My first dive into cost management was a big hit, so I am expanding on that. The main consideration around that particular API is that is it open. Bu this, I mean a simple HTTP request will return results, no authentication or additional headers or the like are needed. So nice and easy. As we dive more into API and REST API&rsquo;s, this is likely to change. This post, with more planned, is designed to make this easier and break it down into smaller chunks. THese chunks/snippets can be re-used and the principles in the chunks/snippets can be applied to other API&rsquo;s. These in particular are aimed at Azure API&rsquo;s."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="http://localhost:1313/" class="no-style site-name">console-demo</a>:~# 
              <a href='http://localhost:1313/posts'>posts</a>/<a href='http://localhost:1313/posts/2023'>2023</a>/<a href='http://localhost:1313/posts/2023/starting-wth-rest-calls-with-powershell'>starting-wth-rest-calls-with-powershell</a>/<a href='http://localhost:1313/posts/2023/starting-wth-rest-calls-with-powershell/about'>about</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="http://localhost:1313/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="http://localhost:1313/posts/" typeof="ListItem">posts/</a></li>
                
                <li><a href="http://localhost:1313/photos/" typeof="ListItem">photos/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>Starting Wth API Rest Calls With Powershell</h1>

Aug. 17, 2023


<br/><br/>
<h2 id="what-are-we-doing">What are we doing?</h2>
<p>I am working more and more with the Azure REST APIs now. My <a href="https://cloud.fskelly.com/post/2023/azure-cost-management-playing-with-api-in-powershell/">first dive into cost management</a> was a big hit, so I am expanding on that. The main consideration around that particular API is that is it open. Bu this, I mean a simple HTTP request will return results, no authentication or additional headers or the like are needed. So nice and easy. As we dive more into API and REST API&rsquo;s, this is likely to change. This post, with more planned, is designed to make this easier and break it down into smaller chunks. THese chunks/snippets can be re-used and the principles in the chunks/snippets can be applied to other API&rsquo;s. These in particular are aimed at Azure API&rsquo;s.</p>
<h2 id="constraints--limitations">Constraints / limitations</h2>
<ol>
<li>Primary focus is on the Azure API.</li>
<li>Using Azure Tokens.</li>
<li>Enterprise Application is already registered.</li>
<li>You have securely stored your secret for the above point.</li>
<li>Designed to be modular - so you can run these in snippets/sections.</li>
<li>This is <strong>NOT PRODUCTION</strong> ready yet.</li>
</ol>
<h2 id="lets-build-this">Lets build this</h2>
<p>Reminder, you will need to have an Application ID, Secret value and Tenant ID on hand as these are needed as part of the API call. <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app">Here</a> is a guide for registering an Azure AD application for testing purposes. Please note that additional controls are needed for production environments.</p>
<p>For production scenarios, secret management should be used as the variables should <strong>NOT</strong> be saved in the file, but instead in a <a href="https://azure.microsoft.com/en-us/products/key-vault">Azure Keyvault</a> and then read out as needed in the script/function/&hellip;.</p>
<p>The process flow for this is as follows.<br>
Perform a rest API Call to get a token -&gt; Save Token in variable -&gt; Use saved variable for subsequent calls.</p>
<h3 id="get-azure-ad-token">Get Azure AD Token</h3>
<p>In this script I am using prompts and obfuscating in the script with the use of the <em>&quot;-AsSecureString&quot;</em>. This will then save the acquired token in the <strong>$token</strong> variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$tenantId = Read-Host <span style="color:#e6db74">&#34;Enter your Azure tenant ID&#34;</span>
</span></span><span style="display:flex;"><span>$clientID = Read-Host <span style="color:#e6db74">&#34;Enter your Azure client ID&#34;</span>
</span></span><span style="display:flex;"><span>$clientSecret = Read-host <span style="color:#e6db74">&#34;enter your client secret&#34;</span> -AsSecureString
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$normalString = [<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::PtrToStringAuto([<span style="color:#66d9ef">System.Runtime.InteropServices.Marshal</span>]::SecureStringToBSTR($clientSecret))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$params = @{
</span></span><span style="display:flex;"><span>    Uri = <span style="color:#e6db74">&#34;https://login.microsoftonline.com/</span>$tenantId<span style="color:#e6db74">/oauth2/v2.0/token&#34;</span>
</span></span><span style="display:flex;"><span>    Method = <span style="color:#e6db74">&#34;POST&#34;</span>
</span></span><span style="display:flex;"><span>    Body = @{
</span></span><span style="display:flex;"><span>        grant_type = <span style="color:#e6db74">&#34;client_credentials&#34;</span>
</span></span><span style="display:flex;"><span>        scope = <span style="color:#e6db74">&#34;https://management.azure.com/.default&#34;</span>
</span></span><span style="display:flex;"><span>        client_id = $clientID
</span></span><span style="display:flex;"><span>        client_secret = $normalString
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$authResult = Invoke-RestMethod @params
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Output the access token</span>
</span></span><span style="display:flex;"><span>$token = $authResult.access_token
</span></span></code></pre></div><p>Now we have our token and we can move onto the next phase, for this I am using a simple Rest API call to get my resource groups, but this token can be used for any api in the <a href="https://management.azure.com/"><em><strong>&ldquo;https://management.azure.com/&rdquo;</strong></em></a> scope, so this would NOT work for an Azure OpenAI Rest API call as the scope is different. A quick search with your choice of search engine will get the correct scope for that. I will create another blog about that soon.</p>
<h3 id="getting-resource-groups-with-an-api-call">Getting resource groups with an API call</h3>
<p>You will see here that the API call needs authorization (US Spelling) and we are using the token from earlier <em>&ldquo;Authorization&rdquo; = &ldquo;Bearer $token&rdquo;</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$subscriptionId = read-host <span style="color:#e6db74">&#34;Enter your subscription ID&#34;</span>
</span></span><span style="display:flex;"><span>$apiVersion = <span style="color:#e6db74">&#34;2020-09-01&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$headers = @{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Authorization&#34;</span> = <span style="color:#e6db74">&#34;Bearer </span>$token<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$params = @{
</span></span><span style="display:flex;"><span>    Uri = <span style="color:#e6db74">&#34;https://management.azure.com/subscriptions/</span>$subscriptionId<span style="color:#e6db74">/resourcegroups?api-version=</span>$apiVersion<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    Method = <span style="color:#e6db74">&#34;GET&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$queryResult = Invoke-RestMethod @params -Headers $headers 
</span></span><span style="display:flex;"><span>$queryResult.value | select-object -Property name,location
</span></span></code></pre></div><p>This same principle can be applied to any API call, just change the scope and the API call. I will be adding more to this as I go along, but this is a good start.</p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
