<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>fletchers-cloud-blog/posts/2023/azure-cost-management-playing-with-api-in-powershell/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Can I run this cheaper? Use case for the Azure Cost Management API" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/2023/azure-cost-management-playing-with-api-in-powershell/" /><meta property="article:published_time" content="2023-08-03T15:24:21+01:00" />



<meta name="twitter:title" content="Can I run this cheaper? Use case for the Azure Cost Management API"/>
<meta name="twitter:description" content="What are we doing?
I was given inspiration by a colleague, Ben Hummerstone who used a Azure Python Function, whilst super cool and interesting, I am a PowerShell advocate through and through. So I used PowerShell and wrote a script to show some of the use cases. This is just the tip of the iceberg and the script has been built to show some of the options available.
Constraints / limitations

The primary focus of this script is IaaS.
Could be better implemented as a function. If there is enough of an ask, I might build this into a function.
Built for my sample use cases.
This is a quick and dirty implementation.
This is NOT PRODUCTION ready yet.

Lets build this
Steps
You will need the following"/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="http://localhost:1313/" class="no-style site-name">fletchers-cloud-blog</a>:~# 
              <a href='http://localhost:1313/posts'>posts</a>/<a href='http://localhost:1313/posts/2023'>2023</a>/<a href='http://localhost:1313/posts/2023/azure-cost-management-playing-with-api-in-powershell'>azure-cost-management-playing-with-api-in-powershell</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="http://localhost:1313/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="http://localhost:1313/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>Can I run this cheaper? Use case for the Azure Cost Management API</h1>

Aug. 3, 2023


<br/><br/>
<h2 id="what-are-we-doing">What are we doing?</h2>
<p>I was given inspiration by a colleague, <a href="https://www.linkedin.com/in/bhummerstone/">Ben Hummerstone</a> who used a <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-python?tabs=asgi%2Capplication-level&amp;pivots=python-mode-configuration">Azure Python Function</a>, whilst super cool and interesting, I am a PowerShell advocate through and through. So I used PowerShell and wrote a script to show some of the use cases. This is just the tip of the iceberg and the script has been built to show some of the options available.</p>
<h2 id="constraints--limitations">Constraints / limitations</h2>
<ol>
<li>The primary focus of this script is IaaS.</li>
<li>Could be better implemented as a function. If there is enough of an ask, I might build this into a function.</li>
<li>Built for my sample use cases.</li>
<li>This is a quick and dirty implementation.</li>
<li>This is <strong>NOT PRODUCTION</strong> ready yet.</li>
</ol>
<h2 id="lets-build-this">Lets build this</h2>
<h3 id="steps">Steps</h3>
<p>You will need the following</p>
<ol>
<li>PowerShell</li>
<li>An understanding of the Cost API (Insert link here)</li>
<li>Willingness to learn and experiment</li>
<li>Postman or the Postman VS Code extension is great for testing, however a normal browser will also return the required details.</li>
</ol>
<p>In essence, there are snippets of code built into one bigger script.</p>
<ol>
<li>Login and list all subscriptions you have access to then pick one to get the vms against.</li>
<li>Check for vms with the same in different resource groups.</li>
<li>We perform an overall call for data.</li>
<li>Check for pagination - as the results are returned 100 rows at a time.</li>
<li>We filter the data - we remove Spot and Low Priority Items.</li>
<li>We find cheaper options with the above filter applied.</li>
<li>We can check against specific regions, again with the filter from step2 applied. Was interesting to get the formatting correct here. :)</li>
</ol>
<p>I will do my best to explain the script, I have also added comments. Please use this as a base and modify as needed. This scripts only <strong>GETS</strong> information, there are <strong>NO WRITES/SETS</strong> in this script. This is by design, please add this functionality yourself.</p>
<p>The snippet below, is designed to allow you to log into Azure (Azure Commercial by default) and then list all the subscriptions you have access to and present a list and then connect to the selected subscription.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Select-SubscriptionsAndConnectTo {
</span></span><span style="display:flex;"><span>    Login-AzAccount
</span></span><span style="display:flex;"><span>    $subscriptions = Get-AzSubscription | Select-Object Name,SubscriptionId | Sort-Object Name 
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">int</span>]$subscriptionCount = $subscriptions.count
</span></span><span style="display:flex;"><span>    Write-output <span style="color:#e6db74">&#34;Found&#34;</span> $subscriptionCount <span style="color:#e6db74">&#34;Subscriptions&#34;</span>
</span></span><span style="display:flex;"><span>    $i = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> ($subscription <span style="color:#66d9ef">in</span> $subscriptions)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $subValue = $i
</span></span><span style="display:flex;"><span>        $subText = [<span style="color:#66d9ef">string</span>]$subValue + <span style="color:#e6db74">&#34; : &#34;</span> + $subscription.Name + <span style="color:#e6db74">&#34; ( &#34;</span> + $subscription.SubscriptionId + <span style="color:#e6db74">&#34; ) &#34;</span>
</span></span><span style="display:flex;"><span>        Write-output $subText
</span></span><span style="display:flex;"><span>        $i++
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Do</span> 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        [<span style="color:#66d9ef">int</span>]$subscriptionChoice = read-host -prompt <span style="color:#e6db74">&#34;Select number &amp; press enter&#34;</span>
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">until</span> ($subscriptionChoice <span style="color:#f92672">-le</span> $subscriptionCount)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $selectedSub = <span style="color:#e6db74">&#34;You selected &#34;</span> + $subscriptions[$subscriptionChoice].Name
</span></span><span style="display:flex;"><span>    Write-output $selectedSub
</span></span><span style="display:flex;"><span>    Set-AzContext -SubscriptionId $subscriptions[$subscriptionChoice].SubscriptionId
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Select-SubscriptionsAndConnectTo
</span></span></code></pre></div><p>Get VMs and check if the same VM name is used in multiple resource groups.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## getting all vms in a subscription</span>
</span></span><span style="display:flex;"><span>$vms = Get-AzVM
</span></span><span style="display:flex;"><span>$vms | Select-Object Name,ResourceGroupName,Location,@{l=<span style="color:#e6db74">&#39;VMSize&#39;</span>;e={$_.HardwareProfile.VmSize}}| Sort-Object Name | Format-Table -AutoSize
</span></span><span style="display:flex;"><span><span style="color:#75715e">## reading in virtual machines</span>
</span></span><span style="display:flex;"><span>$selectedVmName = read-host <span style="color:#e6db74">&#34;Which VM would you like to check for better pricing?&#34;</span>
</span></span><span style="display:flex;"><span>$selectedRGName = $vms | Where-Object { $_.Name <span style="color:#f92672">-eq</span> $selectedVmName } | Select-Object ResourceGroupName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## checking for duplicate names in multiple resource groups</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($selectedRGName.count <span style="color:#f92672">-gt</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $rgCount = $selectedRGName.count
</span></span><span style="display:flex;"><span>    Write-Output <span style="color:#e6db74">&#34;Found multiple VMs with the same name in different resource groups&#34;</span>
</span></span><span style="display:flex;"><span>    $rgNames = $selectedRGName | Select-Object ResourceGroupName
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#write-output $rgNames.resourcegroupname</span>
</span></span><span style="display:flex;"><span>    $i = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> ($rgName <span style="color:#66d9ef">in</span> $rgNames)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $rgValue = $i
</span></span><span style="display:flex;"><span>        $rgText = [<span style="color:#66d9ef">string</span>]$rgValue + <span style="color:#e6db74">&#34; : &#34;</span> + $rgName.ResourceGroupName
</span></span><span style="display:flex;"><span>        Write-output $rgText
</span></span><span style="display:flex;"><span>        $i++
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Do</span> 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        [<span style="color:#66d9ef">int</span>]$rgChoice = read-host -prompt <span style="color:#e6db74">&#34;Select number &amp; press enter&#34;</span>
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">until</span> ($rgChoice <span style="color:#f92672">-le</span> $rgCount-<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $selectedRGText = <span style="color:#e6db74">&#34;You selected &#34;</span> + $selectedRGName[$rgChoice].ResourceGroupName
</span></span><span style="display:flex;"><span>    Write-output $selectedRGText
</span></span><span style="display:flex;"><span>    $selectedRG = $selectedRGName[$rgChoice].ResourceGroupName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## selecting the vm from the selected resource group</span>
</span></span><span style="display:flex;"><span>    $azureVm = get-azvm -ResourceGroupName $selectedRG -Name $selectedVmName
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## selecting the vm from the selected resource group</span>
</span></span><span style="display:flex;"><span>    $azureVm = get-azvm -ResourceGroupName $selectedRGName.ResourceGroupName -Name $selectedVmName
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Getting information about the selected VM and establishing the current base price.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## building variables for api call</span>
</span></span><span style="display:flex;"><span>$azureVMSKU = $azureVm.HardwareProfile.VmSize
</span></span><span style="display:flex;"><span>$azureVmLocation = $azureVm.Location
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## api variables</span>
</span></span><span style="display:flex;"><span>$apiUrl = <span style="color:#e6db74">&#34;https://prices.azure.com/api/retail/prices?&#34;</span>
</span></span><span style="display:flex;"><span>$armSkuName = $azureVMSKU
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## get base information around pricing</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$baseFilter = <span style="color:#e6db74">&#34;armSkuName eq &#39;</span>$armSkuName<span style="color:#e6db74">&#39; and priceType eq &#39;Consumption&#39; and armRegionName eq &#39;</span>$azureVmLocation<span style="color:#e6db74">&#39;&#34;</span>
</span></span><span style="display:flex;"><span>$baseUrl = $apiUrl + <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">filter=</span>$baseFilter<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#e6db74">&#34;Current Url is </span>$baseUrl<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$baseJsonData = Invoke-RestMethod -Uri $baseUrl -Method Get
</span></span><span style="display:flex;"><span><span style="color:#75715e">## selecting most expensive price</span>
</span></span><span style="display:flex;"><span>$baseVMPrice = ($baseJsonData.Items  | Where-Object { $_.skuName <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#34;*Spot*&#34;</span> <span style="color:#f92672">-and</span> $_.skuName <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#34;*Low Priority*&#34;</span> } | Sort-Object unitPrice -Descending | Select-Object -Last <span style="color:#ae81ff">1</span>).unitPrice
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## formatting for results</span>
</span></span><span style="display:flex;"><span>$baseVMPrice = <span style="color:#e6db74">&#34;{0:N4}&#34;</span> <span style="color:#f92672">-f</span> $baseVMPrice
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#e6db74">&#34;Base price is </span>$baseVMPrice<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>Build an array to store the information for later manipulation and sorting. Filter out &ldquo;Low Priority&rdquo; and &ldquo;Spot VMs&rdquo; and deal with pagination.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## get all pricing data for the selected vm</span>
</span></span><span style="display:flex;"><span>$filter = <span style="color:#e6db74">&#34;armSkuName eq &#39;</span>$armSkuName<span style="color:#e6db74">&#39; and priceType eq &#39;Consumption&#39;&#34;</span>
</span></span><span style="display:flex;"><span>$allItems = @()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run Query</span>
</span></span><span style="display:flex;"><span>$url = $apiUrl + <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">filter=</span>$filter<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#e6db74">&#34;Current Url is </span>$url<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$currentJsonData = Invoke-RestMethod -Uri $url -Method Get
</span></span><span style="display:flex;"><span>$allItems += $currentJsonData.Items
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pagination</span>
</span></span><span style="display:flex;"><span>$NextPage = $currentJsonData.NextPageLink
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ($NextPage) {
</span></span><span style="display:flex;"><span>    Write-Verbose <span style="color:#e6db74">&#34;Current Url is </span>$NextPage<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    $currentJsonData = Invoke-RestMethod -Uri $NextPage -Method Get
</span></span><span style="display:flex;"><span>    $allItems += $currentJsonData.Items
</span></span><span style="display:flex;"><span>    $NextPage = $currentJsonData.NextPageLink
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># filter out spot and low priority item from array</span>
</span></span><span style="display:flex;"><span>$filteredItems = $allItems | Select-Object skuName, meterName, unitOfMeasure, @{l=<span style="color:#e6db74">&#39;unitPrice&#39;</span>;e={<span style="color:#e6db74">&#34;{0:N4}&#34;</span> <span style="color:#f92672">-f</span> $_.unitPrice}}, armRegionName | Where-Object { $_.skuName <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#34;*Spot*&#34;</span> <span style="color:#f92672">-and</span> $_.skuName <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#34;*Low Priority*&#34;</span> }
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#e6db74">&#34;Total items: </span>$($filteredItems.Count)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#$filteredItems</span>
</span></span><span style="display:flex;"><span>$filteredItems | Sort-Object -Property unitPrice | Format-Table -AutoSize
</span></span><span style="display:flex;"><span>$cheaperOptions = $filteredItems | Where-Object -Property unitPrice <span style="color:#f92672">-lt</span> $baseVMPrice | Sort-Object -Property unitPrice
</span></span><span style="display:flex;"><span>Write-Output <span style="color:#e6db74">&#34;Cheaper than </span>$baseVMPrice<span style="color:#e6db74"> options: </span>$($cheaperOptions.Count)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$cheaperOptions | Format-Table -Property skuName, meterName, unitOfMeasure, @{l=<span style="color:#e6db74">&#39;unitPrice&#39;</span>;e={<span style="color:#e6db74">&#34;{0:N4}&#34;</span> <span style="color:#f92672">-f</span> $_.unitPrice}}, armRegionName -AutoSize
</span></span></code></pre></div><p>I have also included an option to check against specific regions if that is something you would like to do. You will get prompted if you want to check against other regions. A <strong>Y</strong> will continue to ask which regions, this is a comma seperated list, <em>swedencentral,westeurope</em> (as an example). A <strong>N</strong> will simply stop the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## how to check against specific regions</span>
</span></span><span style="display:flex;"><span>$regionCheck = read-host <span style="color:#e6db74">&#34;Would you like to check against specific regions? (y/n)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span>(<span style="color:#e6db74">&#34;y&#34;</span>,<span style="color:#e6db74">&#34;n&#34;</span> <span style="color:#f92672">-notcontains</span> $regionCheck) {
</span></span><span style="display:flex;"><span>    $regionCheck = read-host <span style="color:#e6db74">&#34;Would you like to check against specific regions? (y/n)&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($regionCheck <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;y&#34;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $specificRegions = read-host <span style="color:#e6db74">&#34;please enter region names separated by comma&#34;</span>
</span></span><span style="display:flex;"><span>    $specificRegions = $specificRegions.split(<span style="color:#e6db74">&#34;,&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $regionItems = @()
</span></span><span style="display:flex;"><span>    $regionQueryBaseUrlFilter = <span style="color:#e6db74">&#34;armSkuName eq &#39;</span>$armSkuName<span style="color:#e6db74">&#39; and priceType eq &#39;Consumption&#39; &#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">foreach</span> ($item <span style="color:#66d9ef">in</span> $specificRegions)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $item
</span></span><span style="display:flex;"><span>        $regionQueryBaseUrlFilter = <span style="color:#e6db74">&#34;armSkuName eq &#39;</span>$armSkuName<span style="color:#e6db74">&#39; and priceType eq &#39;Consumption&#39; &#34;</span>
</span></span><span style="display:flex;"><span>        $regionQueryBaseUrlFilter = $regionQueryBaseUrlFilter + <span style="color:#e6db74">&#34;and armRegionName eq &#39;</span>$item<span style="color:#e6db74">&#39; &#34;</span>
</span></span><span style="display:flex;"><span>        $regionQueryBaseUrlFilter
</span></span><span style="display:flex;"><span>        $regionQueryUrl = $apiUrl + <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">`$</span><span style="color:#e6db74">filter=</span>$regionQueryBaseUrlFilter<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        $otherRegionJsonData = Invoke-RestMethod -Uri $regionQueryUrl -Method Get
</span></span><span style="display:flex;"><span>        $regionItems += $otherRegionJsonData.Items
</span></span><span style="display:flex;"><span>        $NextPage = $otherRegionJsonData.NextPageLink
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> ($NextPage) {
</span></span><span style="display:flex;"><span>            Write-Output <span style="color:#e6db74">&#34;Current Url is </span>$NextPage<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            $otherRegionJsonData = Invoke-RestMethod -Uri $NextPage -Method Get
</span></span><span style="display:flex;"><span>            $regionItems += $otherRegionJsonData.Items
</span></span><span style="display:flex;"><span>            $NextPage = $otherRegionJsonData.NextPageLink
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Write-Output <span style="color:#e6db74">&#34;Output below&#34;</span>
</span></span><span style="display:flex;"><span>    $regionItems | Where-Object { $_.skuName <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#34;*Spot*&#34;</span> <span style="color:#f92672">-and</span> $_.skuName <span style="color:#f92672">-notlike</span> <span style="color:#e6db74">&#34;*Low Priority*&#34;</span> } | Format-Table -Property skuName, meterName, unitOfMeasure, @{l=<span style="color:#e6db74">&#39;unitPrice&#39;</span>;e={<span style="color:#e6db74">&#34;{0:N4}&#34;</span> <span style="color:#f92672">-f</span> $_.unitPrice}}, armRegionName -AutoSize
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Full script can be found <a href="https://github.com/fskelly/flkelly-AzureCode-powershell/blob/main/cost-management/get-vms-list-costings.ps1">here</a></p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
