<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>fletchers-cloud-blog/posts/2023/avs-ldaps-configure/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="http://localhost:1313/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="How to configure LDAPS with AVS" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/2023/avs-ldaps-configure/" /><meta property="article:published_time" content="2023-01-09T08:39:32+00:00" />



<meta name="twitter:title" content="How to configure LDAPS with AVS"/>
<meta name="twitter:description" content="In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).
Pre-requisites

Jump Box
RSAT Tools
PowerShell installed

The expected outcome

Variables we used and information you need
1. Log into Azure
2. Export required certificates
3. Create a storage account
4. Create a container
5. Upload certificates to container
6. Create the SAS Tokens
Execute the AVS Run Command

The plan is to automate as much of this process as possible. We will use PowerShell to complete steps 1-6 as above. For now, step 7 needs to be manual, we are working on automating this as well."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="http://localhost:1313/" class="no-style site-name">fletchers-cloud-blog</a>:~# 
              <a href='http://localhost:1313/posts'>posts</a>/<a href='http://localhost:1313/posts/2023'>2023</a>/<a href='http://localhost:1313/posts/2023/avs-ldaps-configure'>avs-ldaps-configure</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="http://localhost:1313/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="http://localhost:1313/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>How to configure LDAPS with AVS</h1>

Jan. 9, 2023


<br/><br/>
<p>In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).</p>
<p>Pre-requisites</p>
<ol>
<li>Jump Box</li>
<li>RSAT Tools</li>
<li>PowerShell installed</li>
</ol>
<p>The expected outcome</p>
<ul>
<li><a href="#variables-we-used-and-information-you-need">Variables we used and information you need</a></li>
<li><a href="#1-log-into-azure">1. Log into Azure</a></li>
<li><a href="#2-export-required-certificates">2. Export required certificates</a></li>
<li><a href="#3-create-a-storage-account">3. Create a storage account</a></li>
<li><a href="#4-create-a-container">4. Create a container</a></li>
<li><a href="#5-upload-certificates-to-container">5. Upload certificates to container</a></li>
<li><a href="#6-create-the-sas-tokens">6. Create the SAS Tokens</a></li>
<li><a href="#execute-the-avs-run-command">Execute the AVS Run Command</a></li>
</ul>
<p>The plan is to automate as much of this process as possible. We will use PowerShell to complete steps 1-6 as above. For now, step 7 needs to be manual, we are working on automating this as well.</p>
<h2 id="variables-we-used-and-information-you-need">Variables we used and information you need</h2>
<p>We use the following.<br>
DNS Name = avsemea.com<br>
Netbios Name = AVSEMEA<br>
You will see that we use the Fully Qualified domain names later with the computer names we reference later. We use FQDN as much as possible and try to hard code as little making these snippets more portable into your environment(s).</p>
<p>We are using a jump-box, which is domain joined, deployed into Azure and protected with <a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview">Azure Bastion</a>. THe snippets below are run on this jump-box, which has <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/remote-server-administration-tools">RSAT</a> installed.</p>
<h2 id="1-log-into-azure">1. Log into Azure</h2>
<p>Update the variables as needed, in this case, <em><strong>$azSubscriptionID</strong></em></p>
<p><strong>Notes</strong><br>
<em><strong>$azSubscriptionID</strong></em> would need to be updated with your Subscription ID.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$azSubscriptionID = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>Login-AzAccount
</span></span><span style="display:flex;"><span>Set-AzContext -Subscription $azSubscriptionID
</span></span></code></pre></div><h2 id="2-export-required-certificates">2. Export required certificates</h2>
<p>You will need to have OpenSSL installed. You can do this manually, or use a package manager like <a href="https://winget.run/pkg/ShiningLight/OpenSSL">winget</a> or
<a href="https://community.chocolatey.org/packages/openssl">chocolatey</a></p>
<p><strong>Notes</strong><br>
<em><strong>$openSSLFilePath</strong></em> may need to be changed, was installed using <a href="https://community.chocolatey.org/packages/openssl">chocolatey</a> in our example.<br>
<em><strong>$remoteComputers</strong></em> would need to be changed to suit your environment.<br>
<em><strong>$exportFolder</strong></em> can be changed to something more suitable for your environment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## Get certs</span>
</span></span><span style="display:flex;"><span>$openSSLFilePath = <span style="color:#e6db74">&#34;C:\Program Files\OpenSSL-Win64\bin\openssl.exe&#34;</span>
</span></span><span style="display:flex;"><span>$remoteComputers = <span style="color:#e6db74">&#34;avs-gwc-dc001.avsemea.com&#34;</span>,<span style="color:#e6db74">&#34;avs-gwc-dc002.avsemea.com&#34;</span>
</span></span><span style="display:flex;"><span>$port = <span style="color:#e6db74">&#34;636&#34;</span>
</span></span><span style="display:flex;"><span>$exportFolder = <span style="color:#e6db74">&#34;c:\temp\&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($computer <span style="color:#66d9ef">in</span> $remoteComputers)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $output =  echo <span style="color:#e6db74">&#34;1&#34;</span> | &amp; $openSSLFilePath <span style="color:#e6db74">&#34;s_client&#34;</span> <span style="color:#e6db74">&#34;-connect&#34;</span> <span style="color:#e6db74">&#34;</span>$computer<span style="color:#e6db74">`:</span>$port<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;-showcerts&#34;</span> | out-string
</span></span><span style="display:flex;"><span>    $Matches = $null
</span></span><span style="display:flex;"><span>    $cn = $output <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#34;0 s\:CN = (?&lt;cn&gt;.*?)\r\n&#34;</span>
</span></span><span style="display:flex;"><span>    $cn = $Matches.cn
</span></span><span style="display:flex;"><span>    $Matches = $null
</span></span><span style="display:flex;"><span>    $certs = select-string -inputobject $output -pattern <span style="color:#e6db74">&#34;(?s)(?&lt;cert&gt;-----BEGIN CERTIFICATE-----.*?-----END CERTIFICATE-----)&#34;</span> -allmatches
</span></span><span style="display:flex;"><span>    $cert = $certs.matches[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    $exportPath = $exportFolder+($computer.split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">0</span>])+<span style="color:#e6db74">&#34;.cer&#34;</span>
</span></span><span style="display:flex;"><span>    $cert.Value | Out-File $exportPath -Encoding ascii
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can see the exported files in the picture below.</p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet1.jpg"
    alt="code-snippet-1">
</figure>

<h2 id="3-create-a-storage-account">3. Create a storage account</h2>
<p><strong>Notes</strong><br>
<em><strong>$resourceGroupLocation</strong></em> will need to be updated to your desired location.<br>
<em><strong>$storageRgName</strong></em> will need to be updated.<br>
<em><strong>$storageAccountName</strong></em> will need to be updated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## create storage account</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$resourceGroupLocation = <span style="color:#e6db74">&#34;germanywestcentral&#34;</span>
</span></span><span style="display:flex;"><span>$storageRgName = <span style="color:#e6db74">&#34;avs-</span>$resourceGroupLocation<span style="color:#e6db74">-operational_rg&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Storage account variables</span>
</span></span><span style="display:flex;"><span>$guid = New-Guid
</span></span><span style="display:flex;"><span>$storageAccountName = <span style="color:#e6db74">&#34;avsgwcsa&#34;</span>
</span></span><span style="display:flex;"><span>$storageAccountNameSuffix = $guid.ToString().Split(<span style="color:#e6db74">&#34;-&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>$storageAccountName = (($storageAccountName.replace(<span style="color:#e6db74">&#34;-&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>))+$storageAccountNameSuffix )
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Define tags to be used if needed</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## tags can be modified to suit your needs, another example below.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#$tags = @{&#34;Environment&#34;=&#34;Development&#34;;&#34;Owner&#34;=&#34;FTA&#34;;&#34;CostCenter&#34;=&#34;123456&#34;}</span>
</span></span><span style="display:flex;"><span>$tags = @{<span style="color:#e6db74">&#34;deploymentMethod&#34;</span>=<span style="color:#e6db74">&#34;PowerShell&#34;</span>; <span style="color:#e6db74">&#34;Technology&#34;</span>=<span style="color:#e6db74">&#34;AVS&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">## create storage account</span>
</span></span><span style="display:flex;"><span>$saCheck = Get-AzStorageAccount -ResourceGroupName $storageRgName -Name $storageAccountName -ErrorAction SilentlyContinue
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($null <span style="color:#f92672">-eq</span> $saCheck)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    New-AzStorageAccount -ResourceGroupName $storageRgName -Name $storageAccountName -Location $resourceGroupLocation -SkuName Standard_LRS -Kind StorageV2 -EnableHttpsTrafficOnly $true -Tags $tags
</span></span><span style="display:flex;"><span>    Write-Output <span style="color:#e6db74">&#34;Storage account created: </span>$storageAccountName<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    write-output <span style="color:#e6db74">&#34;Storage Account already exists&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet2.jpg"
    alt="code-snippet-2">
</figure>

<h2 id="4-create-a-container">4. Create a container</h2>
<p><strong>Notes</strong><br>
<em><strong>$containerName</strong></em> will need to be updated</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## create container</span>
</span></span><span style="display:flex;"><span>$containerName = <span style="color:#e6db74">&#34;ldaps&#34;</span>
</span></span><span style="display:flex;"><span>$containerCheck = Get-AzStorageContainer -name $containerName -Context (Get-AzStorageAccount -ResourceGroupName $storageRgName -Name $storageAccountName).Context -ErrorAction SilentlyContinue
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($null <span style="color:#f92672">-eq</span> $containerCheck)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    New-AzStorageContainer -name $containerName -Context (Get-AzStorageAccount -ResourceGroupName $storageRgName -Name $storageAccountName).Context
</span></span><span style="display:flex;"><span>    Write-Output <span style="color:#e6db74">&#34;Storage container created: </span>$containerName<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    write-output <span style="color:#e6db74">&#34;Container already exists&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet3.jpg"
    alt="code-snippet-3">
</figure>

<h2 id="5-upload-certificates-to-container">5. Upload certificates to container</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## upload certs to container</span>
</span></span><span style="display:flex;"><span>$certs = Get-ChildItem -Path $exportFolder -Filter *.cer
</span></span><span style="display:flex;"><span>$storageContext = (Get-AzStorageAccount -Name $storageAccountName -ResourceGroupName $storageRgName).Context
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($item <span style="color:#66d9ef">in</span> $certs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $localFilePath = $item.FullName
</span></span><span style="display:flex;"><span>    $azureFileName = $localFilePath.Split(<span style="color:#e6db74">&#39;\&#39;</span>)[$localFilePath.Split(<span style="color:#e6db74">&#39;\&#39;</span>).count-<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    Get-AzStorageAccount -Name $storageAccountName -ResourceGroupName $storageRgName | Get-AzStorageContainer -Name $containerName | Set-AzStorageBlobContent <span style="color:#f92672">-File</span> $localFilePath -Blob $azureFileName
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet5.jpg"
    alt="code-snippet-5">
</figure>

<h2 id="6-create-the-sas-tokens">6. Create the SAS Tokens</h2>
<p><strong>Notes</strong><br>
<em><strong>$containerName</strong></em> will need to be updated</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## create SAS token</span>
</span></span><span style="display:flex;"><span>$containerName = <span style="color:#e6db74">&#34;ldaps&#34;</span>
</span></span><span style="display:flex;"><span>$blobs = Get-AzStorageBlob -Container $containerName -Context $storageContext | Where-Object {$_.name <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#34;.cer&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($blob <span style="color:#66d9ef">in</span> $blobs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $StartTime = Get-Date
</span></span><span style="display:flex;"><span>    $EndTime = $startTime.AddHours(<span style="color:#ae81ff">24.0</span>)
</span></span><span style="display:flex;"><span>    $sasToken = New-AzStorageBlobSASToken -Container $containerName -Blob $blob.name -Permission rwd -StartTime $StartTime -ExpiryTime $EndTime -Context $storageContext -FullUri
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#$sasToken</span>
</span></span><span style="display:flex;"><span>    write-host <span style="color:#e6db74">&#34;SASToken created: </span>$sasToken<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet5.jpg"
    alt="code-snippet-5">
</figure>

<p>SASToken created: <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a><br>
SASToken created: <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a></p>
<h2 id="execute-the-avs-run-command">Execute the AVS Run Command</h2>
<p>These steps, for now, are run manually from the <a href="https://portal.azure.com">Azure Portal</a>. This will be found &ldquo;Azure VMware Solution&rdquo; and under Operations, <strong>Run command</strong>. Then select <strong>&ldquo;New-LDAPSIdentitySource&rdquo;</strong></p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet7.jpg"
    alt="code-snippet-7">
</figure>

<p>Populate the information as needed.<br>
<strong>Note: the SSLCertificateSasUrl is a single string consisting of the SASTokens separated with a “,”. For example, <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a>, <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a> and pasted as a single long string.</strong>
The other values would need to be updated as per your environment.<br>
<strong>Note: With the BaseDNGroups and BaseDNUsers, watch the values used as these should be under the same tree, in this example, “OU=Corp,DC=avsemea,DC=com”</strong></p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet8.jpg"
    alt="code-snippet-8">
</figure>

<p>Once all information is entered, Run the command.</p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet9.jpg"
    alt="code-snippet-9">
</figure>

<p>You can check the status of the <strong>Run command</strong> within the portal, under Operations, <strong>Run command</strong>, then select <strong>Run execution status</strong> and then select the correct job.</p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet10.jpg"
    alt="code-snippet-10">
</figure>

<p>You can check the status of the job now and you are waiting for all the tasks to be completed and show that your selected group was added to <strong>CloudAdmins</strong></p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet11.jpg"
    alt="code-snippet-11">
</figure>

<p>You can also check the output and ensure that the correct name was added.</p>
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet12.jpg"
    alt="code-snippet-12">
</figure>

<p>You can logon with LDAP based credentials.
<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet13.jpg"
    alt="code-snippet-13">
</figure>

<figure><img src="/images/blogImages/2023/avs-ldaps-configure/snippet14.jpg"
    alt="code-snippet-14">
</figure>
</p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
