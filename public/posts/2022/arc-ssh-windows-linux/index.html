<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>fletchers-cloud-blog/posts/2022/arc-ssh-windows-linux/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://example.com/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="https://example.com/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="https://example.com/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Using Arc to SSH into Linux and Windows" />
<meta property="og:description" content="Using Arc to SSH into Linux and Windows" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/posts/2022/arc-ssh-windows-linux/" /><meta property="article:published_time" content="2022-09-27T08:03:53+01:00" />



<meta name="twitter:title" content="Using Arc to SSH into Linux and Windows"/>
<meta name="twitter:description" content="Using Arc to SSH into Linux and Windows"/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://example.com/" class="no-style site-name">fletchers-cloud-blog</a>:~# 
              <a href='https://example.com/posts'>posts</a>/<a href='https://example.com/posts/2022'>2022</a>/<a href='https://example.com/posts/2022/arc-ssh-windows-linux'>arc-ssh-windows-linux</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://example.com/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://example.com/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>Using Arc to SSH into Linux and Windows</h1>

Sep. 27, 2022


<br/><br/>
<h2 id="what-are-we-doing">What are we doing?</h2>
<p>We are going to use Azure Arc to SSH into a Linux (ubuntu 20.04) and a Windows Server (Server 2019) machine and run commands.</p>
<h2 id="constraints--limitations">Constraints / limitations</h2>
<ol>
<li>Use only Azure ARC.</li>
<li>Use only public endpoints (I have not yet tested this with Private Endpoints) and my VPN is not currently connected to Azure.</li>
</ol>
<h2 id="considerations">Considerations</h2>
<p>As of the time of this blog post (27-Sep-2022), the <a href="https://learn.microsoft.com/en-us/azure/azure-arc/servers/ssh-arc-overview">Azure Arc SSH</a> functionality is in preview.</p>
<h2 id="lets-build-this">Lets build this</h2>
<p>So, we are going to use SSH to connect to both Linux and Windows. Yes, you can connect to Windows via SSH and yes it works, we will get this working in this post.</p>
<h3 id="steps">Steps</h3>
<ol>
<li>Install Azure Arc Agent on VMs</li>
<li>Ensure that it is connected to Azure Correctly</li>
<li>Configurations changes for SSH to work</li>
<li>Connect via SSH</li>
</ol>
<p>I am going to assume that steps 1 and 2 are completed already, if not. See <a href="https://learn.microsoft.com/en-us/azure/azure-arc/servers/deployment-options">here</a>. The focus on this post is to connect to your environment using the <a href="https://learn.microsoft.com/en-us/azure/azure-arc/servers/ssh-arc-overview">azcmagent</a> and then connecting to the virtual machine via the portal.</p>
<h3 id="linux-vm">Linux VM</h3>
<figure><img src="/images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-linux-vm.png"
    alt="Connect via portal to linux Azure Arc machine" width="900" height="300">
</figure>

<p>You will see that this is a linux vm and SSH working here is no surprise. For this post, I am using password authentication type. <strong>This is not ideal for production</strong>.
<figure><img src="/images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-linux-vm-connectoptions.png"
    alt="Connect via portal to linux Azure Arc machine options" width="900" height="300">
</figure>

Now you can click, &ldquo;Connect in browser&rdquo;. This will launch an <a href="https://learn.microsoft.com/en-us/azure/cloud-shell/overview">Azure Cloud Shell</a>
<figure><img src="/images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-linux-vm-connect-in-browser.png"
    alt="Connect via portal to linux Azure Arc machine button - connect in browser" width="900" height="300">
</figure>
</p>
<h2 id="gotcha">GOTCHA</h2>
<p>You may hit your first error here.
<figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-linux-vm-error-1.png"
    alt="Connect via portal to linux Azure Arc machine button - connection error">
</figure>
</p>
<p>The error may seem a little strange, it seems it is using port 66535 to dp a port lookup - like a proxy lookup - see <a href="https://serverfault.com/questions/915724/connection-closed-by-unknown-port-65535-when-ssh-using-ad-creds-on-rhel-machine">here</a> as an example of this. It is still wanting to connect to port 22, the normal ssh port. <em>So how do we fix this?</em></p>
<p>Configuring the <strong>Az</strong>ure <strong>c</strong>onnected <strong>ma</strong>chine <strong>agent</strong> is documented <a href="https://learn.microsoft.com/en-us/azure/azure-arc/servers/ssh-arc-overview">here</a> and the command we need is this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>azcmagent config set incomingconnections.ports <span style="color:#ae81ff">22</span>
</span></span></code></pre></div><p>Run this command on your linux machine (sudo will be needed)
<figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-linux-vm-fix1.png"
    alt="Update port number from azcmagent">
</figure>

and then we can connect<br>
<figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-linux-vm-connect-1.png"
    alt="Connect via portal to linux Azure Arc machine is successful">
</figure>
</p>
<h3 id="windows-vm">Windows VM</h3>
<figure><img src="/images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-windows-vm.png"
    alt="Connect via portal to Windows Azure Arc machine" width="900" height="300">
</figure>

<p>The steps for connection from the portal and the required <strong>Az</strong>ure <strong>c</strong>onnected <strong>ma</strong>chine <strong>agent</strong> commands are the same. However we do need to get SSH working on the Windows Server, this is actually quite easy and simply needs some copy and paste, see <a href="https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse?tabs=powershell">here</a>. Once you have done that, your connection will work.</p>
<figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/arc-ssh-windows-linux/connect-button-portal-windows-vm-connect-1.png"
    alt="Connect via portal to Windows Azure Arc machine is successful">
</figure>

<p>So there you have it, an SSH connection from the Azure portal to a Windows AND Linux Arc-enabled machine.</p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
