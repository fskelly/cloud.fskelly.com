<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>fletchers-cloud-blog/posts/2022/bicep-linux-vm-ssh-keys/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://cloud.fskelly.com/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="https://cloud.fskelly.com/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="https://cloud.fskelly.com/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Using SSH Keys with Bicep based Linux VM templates" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cloud.fskelly.com/posts/2022/bicep-linux-vm-ssh-keys/" /><meta property="article:published_time" content="2022-06-20T08:54:21+01:00" />



<meta name="twitter:title" content="Using SSH Keys with Bicep based Linux VM templates"/>
<meta name="twitter:description" content="I this post, I use bicep files for the deployment of Linux VMs AND I add some magic with PowerSehll to allow for the creation or using of existing SSH keys with these VMs.
I am a HUGE fan of SSH keys with Linux VMs for obvious reasons. I could just not find a script or scenario that covered this topic in a way that I actually like. I like to show more details and explain."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://cloud.fskelly.com/" class="no-style site-name">fletchers-cloud-blog</a>:~# 
              <a href='https://cloud.fskelly.com/posts'>posts</a>/<a href='https://cloud.fskelly.com/posts/2022'>2022</a>/<a href='https://cloud.fskelly.com/posts/2022/bicep-linux-vm-ssh-keys'>bicep-linux-vm-ssh-keys</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://cloud.fskelly.com/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://cloud.fskelly.com/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>Using SSH Keys with Bicep based Linux VM templates</h1>

Jun. 20, 2022


<br/><br/>
<p>I this post, I use bicep files for the deployment of Linux VMs AND I add some magic with PowerSehll to allow for the creation or using of existing SSH keys with these VMs.</p>
<p>I am a HUGE fan of SSH keys with Linux VMs for obvious reasons. I could just not find a script or scenario that covered this topic in a way that I actually like. I like to show more details and explain.</p>
<p>In this scenario, we use PowerShell to create the SSH keys and then use the value to the SSH key to deploy the Linux VM or use an existing SSH key adn then use that kay as part of the deployment. All automated, you just need to update some variables and let the script run. Who does not love automated examples ? :smile:</p>
<p>SSH Keys give us a secure and reliable way to connect to Linux VMs without the use of usernames and passwords. Naturally the keys would need to be protected. Maybe in another post I will create a keyVault to show this process.</p>
<p>Note: Please use 1A OR 1B<br>
A. Create new keys<br>
b. Use existing Keys</p>
<h2 id="1a-create-the-ssh-keys-if-using-the-option-to-create-keys-filehttpsgithubcomfskellyflkelly-azurecode-bicepblobmainexamplesvmlinuxvmdeploywithnewkeyps1">1A. Create the SSH Keys (if using the option to create keys) <a href="https://github.com/fskelly/flkelly-AzureCode-bicep/blob/main/examples/vm/linuxVM/deployWithNewKey.ps1">file</a></h2>
<p>Please remember to update the variables as needed.<br>
Variables to update</p>
<ol>
<li>$vmName</li>
<li><strong>If</strong> you want to change the path of the created keys - $keyLocation</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## Pre-req</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Create required ssh-keys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Requires ssh-keygen to be installed</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$vmName = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>$keyLocation  = $env:USERPROFILE + <span style="color:#e6db74">&#34;\.ssh\&#34;</span>
</span></span><span style="display:flex;"><span>$privateKeyName = $vmName + <span style="color:#e6db74">&#34;-key&#34;</span>
</span></span><span style="display:flex;"><span>$publicKeyName = $vmName + <span style="color:#e6db74">&#34;-key.pub&#34;</span>
</span></span><span style="display:flex;"><span>$privateKeyPath = $keyLocation + $privateKeyName
</span></span><span style="display:flex;"><span>$publicKeyPath  = $keyLocation + $publicKeyName
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh-keygen -m PEM -t rsa -b <span style="color:#ae81ff">2048</span> -C $vmName <span style="color:#f92672">-f</span> $privateKeyPath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##Deploy</span>
</span></span><span style="display:flex;"><span>$sshKey = Get-Content $publicKeyPath
</span></span><span style="display:flex;"><span>$secureSSHKey = ConvertTo-SecureString $sshKey -AsPlainText -Force
</span></span></code></pre></div><h2 id="1b-us-existing-ssh-keys-if-using-the-option-to-create-keys-filehttpsgithubcomfskellyflkelly-azurecode-bicepblobmainexamplesvmlinuxvmdeploywithexistingkeyps1">1B. Us existing SSH Keys (if using the option to create keys) <a href="https://github.com/fskelly/flkelly-AzureCode-bicep/blob/main/examples/vm/linuxVM/deployWithExistingKey.ps1">file</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## Get key data</span>
</span></span><span style="display:flex;"><span>$publicKeyPath = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>$sshKey = Get-Content $publicKeyPath
</span></span><span style="display:flex;"><span>$secureSSHKey = ConvertTo-SecureString $sshKey -AsPlainText -Force
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$privateKeyPath = <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div><h2 id="2-deploy-the-bicep-template-filehttpsgithubcomfskellyflkelly-azurecode-bicepblobmainexamplesvmlinuxvmmainbicep">2. Deploy the Bicep Template <a href="https://github.com/fskelly/flkelly-AzureCode-bicep/blob/main/examples/vm/linuxVM/main.bicep">file</a></h2>
<p>Please remember to update the variables as needed.<br>
Variables to update</p>
<ol>
<li>$resourceGroupName</li>
<li>$resourceGroupLocation</li>
<li>$userName</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## Deploy to Azure</span>
</span></span><span style="display:flex;"><span>$resourceGroupName = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>$resourceGroupLocation = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>$userName = <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>New-AzResourceGroup -Name $resourceGroupName -Location $resourceGroupLocation
</span></span><span style="display:flex;"><span>New-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName -TemplateFile ./main.bicep -adminUsername $userName -adminPasswordOrKey $secureSSHKey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$hostName = (Get-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName).outputs.hostname.value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Adding slight delay</span>
</span></span><span style="display:flex;"><span>Start-Sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## Connect to the vm</span>
</span></span><span style="display:flex;"><span>ssh -i $privateKeyPath $userName@$hostName
</span></span></code></pre></div><p>Now you can automatically connect to your newly deployed VM with an SSH Key. How great is that?</p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
