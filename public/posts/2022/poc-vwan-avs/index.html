<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>fletchers-cloud-blog/posts/2022/poc-vwan-avs/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://cloud.fskelly.com/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="https://cloud.fskelly.com/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="https://cloud.fskelly.com/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Using Azure Virtual WAN to connect to Azure VMware Solution" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cloud.fskelly.com/posts/2022/poc-vwan-avs/" /><meta property="article:published_time" content="2022-03-28T07:27:16+01:00" />



<meta name="twitter:title" content="Using Azure Virtual WAN to connect to Azure VMware Solution"/>
<meta name="twitter:description" content="How do I connect my on-premises environment to AVS in a quick and simple way?
There are a few patterns available for connecting Azure VMware Solution to your on-premises network. There is specific guidance for PRODUCTION deployments here here. The option we are talking about here is for a different use case.
Specific use case: A PoC (Proof of Concept) type environment or smaller environments for testing with a plan to grow after the fact."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://cloud.fskelly.com/" class="no-style site-name">fletchers-cloud-blog</a>:~# 
              <a href='https://cloud.fskelly.com/posts'>posts</a>/<a href='https://cloud.fskelly.com/posts/2022'>2022</a>/<a href='https://cloud.fskelly.com/posts/2022/poc-vwan-avs'>poc-vwan-avs</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://cloud.fskelly.com/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://cloud.fskelly.com/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast" >
        
<h1>Using Azure Virtual WAN to connect to Azure VMware Solution</h1>

Mar. 28, 2022


<br/><br/>
<h2 id="how-do-i-connect-my-on-premises-environment-to-avs-in-a-quick-and-simple-way">How do I connect my on-premises environment to AVS in a quick and simple way?</h2>
<p>There are a few patterns available for connecting <a href="https://docs.microsoft.com/en-us/azure/azure-vmware/introduction">Azure VMware Solution</a> to your on-premises network. There is specific guidance for PRODUCTION deployments here <a href="https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/scenarios/azure-vmware/eslz-network-topology-connectivity">here</a>. The option we are talking about here is for a different use case.</p>
<p><strong>Specific use case:</strong> A <em><strong>PoC (Proof of Concept)</strong></em> type environment or smaller environments for testing with a plan to grow after the fact.</p>
<p>Azure Virtual WAN is one of the easy ways to get this accomplished. Below, we are going to work through an example.</p>
<h2 id="what-are-we-going-to-deploy">What are we going to deploy?</h2>
<figure><img src="/images/blogImages/2022/vwan-avs-poc/topology.jpg"
    alt="deployed vwan topology" width="900" height="300">
</figure>

<p>We are going to use <a href="https://docs.microsoft.com/en-us/azure/virtual-wan/virtual-wan-about">Azure Virtual WAN</a> to allow for a connection from on-premises to <a href="https://docs.microsoft.com/en-us/azure/azure-vmware/introduction">Azure VMware Solution</a>.</p>
<p>I have this as modular as possible with <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-logical#bool">booleans</a> in <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/overview?tabs=bicep">Bicep</a> to make this is as customizable as possible for you.</p>
<blockquote>
<p><strong>A VPN Gateway will be deployed.</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bicep" data-lang="bicep"><span style="display:flex;"><span>@<span style="color:#a6e22e">description</span>(<span style="color:#e6db74">&#39;Specifies whether or not to deploy the site to site connection.&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> deployS2SConnection bool = <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><blockquote>
<p><strong>An ExpressRoute Gateway will be deployed.</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bicep" data-lang="bicep"><span style="display:flex;"><span>@<span style="color:#a6e22e">description</span>(<span style="color:#e6db74">&#39;Specifies whether or not to deploy ExR connection.&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> deployExRConnection bool = <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>ðŸ’ª Bicep code can be found <a href="https://github.com/fskelly/flkelly-AzureCode-bicep/tree/main/examples/virtualWan/AVS/module-example">here</a>.</p>
<p>What to expect when deploying?</p>
<ol>
<li>You will get an ExpressRoute gateway. I set this as a &ldquo;true&rdquo; boolean value to cater for this.</li>
<li>The deployment will happen over 2 resource groups - if deploying the &ldquo;vnetconnection&rdquo; option.  <figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/vwan-avs-poc/2resourcegoups.jpg"
    alt="deployment screenshot showing the 2 deployed resource groups">
</figure>
</li>
<li>It will look like nothing is happening in the Virtual WAN resource group. Show hidden items here.  <figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/vwan-avs-poc/showHiddenTypes.jpg"
    alt="deployment screenshot showing hidden items checked">
</figure>
</li>
<li>The deployment, if choosing anything Gateway related (VPN Gateway or ExpressRoute gateway) will take some time - up to 35 minutes.  <figure><img src="https://raw.githubusercontent.com/fskelly/cloud.fskelly.com/main/static//images/blogImages/2022/vwan-avs-poc/vHubDeploy.jpg"
    alt="deployment screenshot showing times">
</figure>
</li>
<li>The deployment will deploy a VPN Gateway (on-premises to Azure)</li>
<li>The deployment will deploy a ExR Gateway (Azure to AVS)</li>
</ol>
<p>This deployment is based upon this <a href="https://docs.microsoft.com/en-us/azure/azure-vmware/configure-site-to-site-vpn-gateway">Configure a site-to-site VPN in vWAN for Azure VMware Solution</a>. Whilst I like this article, it is not 100% complete. For the <a href="https://docs.microsoft.com/en-us/azure/azure-vmware/introduction">Azure VMware Solution</a> (AVS) to work fully, an <a href="https://docs.microsoft.com/en-us/azure/virtual-wan/virtual-wan-expressroute-portal">ExpressRoute Gateway for Azure Virtual WAN</a> is needed. I prefer an IaC approach as the <a href="https://portal.azure.com">Azure Portal</a> UI can change and I like repeatable processes.</p>
<figure><img src="/images/blogImages/2022/vwan-avs-poc/topology.jpg"
    alt="deployed vwan topology" width="900" height="300">
</figure>

<p>This solution then allow you connect your on-premises environment to connect to <a href="https://docs.microsoft.com/en-us/azure/azure-vmware/introduction">Azure VMware Solution</a>. This is probably one of the easiest ways to connect to <a href="https://docs.microsoft.com/en-us/azure/azure-vmware/introduction">Azure VMware Solution</a></p>
<p><a href="https://docs.microsoft.com/en-us/azure/virtual-wan/virtual-wan-about">Azure Virtual WAN</a> can be further extended to ALSO include Point-to-Site connections - <a href="https://mecdata.it/en/2020/06/configure-a-point-to-site-vpn-connection-via-openvpn/">This</a> is a good starting point for building the certificates (self-signed) for the Point-To-Site connections, if you choose to deploy this.</p>
<p><em><strong>DISCLAIMER:</strong></em>
<strong>These files are NOT production ready, they used to explain concepts and better prepare you for production.</strong></p>



        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
